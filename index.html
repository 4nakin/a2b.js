<!doctype html>
<html>
	<head>
		<title>A2B in three.js</title>
		<!--A2B game by Telecoda 
			 threejs & physic.js game -->
		
		<!-- using -->
		<!-- three.js by Mr Doob https://github.com/mrdoob/three.js.git -->
		<!-- threejsboilerplate https://github.com/jeromeetienne/threejsboilerplate -->
		<!-- physicjs https://github.com/chandlerprall/Physijs -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="vendor/three.js/three.min.js"></script>
		<script src="vendor/three.js/Detector.js"></script>
		<!-- https://github.com/mrdoob/stats.js -->
		<script src="vendor/three.js/tween.js"></script>
		<script src="vendor/three.js/Stats.js"></script>

		<script src="vendor/threex/THREEx.screenshot.js"></script>
		<script src="vendor/threex/THREEx.FullScreen.js"></script>
		<script src="vendor/threex/THREEx.WindowResize.js"></script>
		<script type="text/javascript" src="vendor/physi.js/physi.js"></script>
		<!-- game specific scripts -->
		<script type="text/javascript" src="js/player.js"></script>
		<script type="text/javascript" src="js/game.js"></script>
		<script type="text/javascript" src="js/gamestats.js"></script>
		<script type="text/javascript" src="js/graphics.js"></script>

		<script type="text/javascript" src="fonts/gentilis_bold.typeface.js"></script>
		<script type="text/javascript" src="fonts/gentilis_regular.typeface.js"></script>
		<script type="text/javascript" src="fonts/optimer_bold.typeface.js"></script>
		<script type="text/javascript" src="fonts/optimer_regular.typeface.js"></script>
		<script type="text/javascript" src="fonts/helvetiker_bold.typeface.js"></script>
		<script type="text/javascript" src="fonts/helvetiker_regular.typeface.js"></script>
		<script type="text/javascript" src="fonts/droid/droid_sans_regular.typeface.js"></script>
		<script type="text/javascript" src="fonts/droid/droid_sans_bold.typeface.js"></script>
		<script type="text/javascript" src="fonts/droid/droid_serif_regular.typeface.js"></script>
		<script type="text/javascript" src="fonts/droid/droid_serif_bold.typeface.js"></script>


		<link  href="css/main.css" rel="stylesheet"/>
	</head>
<body>
	<!-- three.js container -->
    	<div id="container"></div>
	<!-- info on screen display -->
	<div id="info">
		<div class="top">
			<h1>A2B in three.js</h1>
	<div id="startButtonDiv">
		<span class="button" onclick="startGame()">Start Game</span>
		<!--<img src="images/start_game.png" onclick="startGame()" id="startButton"></img>-->
	</div> 
		</div>
	<div id="viewport"></div>

		<div class="bottom" id="inlineDoc" >
			- <i>p</i> for screenshot
		</div> 
	</div> 

	<script type="text/javascript">
		'use strict';
	
		Physijs.scripts.worker = 'vendor/physi.js/physijs_worker.js';
		Physijs.scripts.ammo = 'ammo.js';

// methods
var startGame, render, setMousePosition, mouse_position
// vars
var  projector, stats, gamestats, scene, camera;

var materials;
	
var cameraControls;

var game;

var mouse = { x: 0, y: 0 }, INTERSECTED;

startGame = function() {

		// hide start button
		document.getElementById( 'startButtonDiv' ).style.display='none';

		
		projector = new THREE.Projector;
		
	 
		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		stats.domElement.style.zIndex = 100;
		document.getElementById( 'viewport' ).appendChild( stats.domElement );
		
		gamestats = new GameStats();
		gamestats.domElement.style.position = 'absolute';
		gamestats.domElement.style.top = '0px';
		gamestats.domElement.style.right = '0px';
		gamestats.domElement.style.zIndex = 100;
		document.getElementById( 'viewport' ).appendChild( gamestats.domElement );


		scene = new Physijs.Scene;
		scene.setGravity({ x: 0, y: -20, z: 0 });	
	
/*		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			1000
		); */
		camera = new THREE.PerspectiveCamera(
			35,
			window.innerWidth / window.innerHeight,
			1,
			1000
		);
		camera.position.set( 0, 50, 120 );
		//camera.position.set( 60, 50, 120 );
		camera.lookAt( scene.position );

		cameraControls	= new THREE.TrackballControls(camera);
		
		cameraControls.target.set(0,0,0);

		scene.add( camera );
	
		game = new A2B.Game(scene,camera);

		//game.addWebUI();

		game.startGame();
			
		// add keyboard controls
		// transparently support window resize
			THREEx.WindowResize.bind(game.getRenderer(), camera);
			// allow 'p' to make screenshot
			THREEx.Screenshot.bindKey(game.getRenderer());
			// allow 'f' to go fullscreen where this feature is supported
			if( THREEx.FullScreen.available() ){
				THREEx.FullScreen.bindKey();		
				document.getElementById('inlineDoc').innerHTML	+= "- <i>f</i> for fullscreen";
			}


		requestAnimationFrame( render );
		game.getRenderer().domElement.addEventListener( 'mousemove', setMousePosition );
	

	};

setMousePosition = function( evt ) {
		// Find where mouse cursor intersects the ground plane
		mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
		mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

		var vector = new THREE.Vector3(
			( evt.clientX / game.getRenderer().domElement.clientWidth ) * 2 - 1,
			-( ( evt.clientY / game.getRenderer().domElement.clientHeight ) * 2 - 1 ),
			.5
		);
		projector.unprojectVector( vector, camera );
		vector.subSelf( camera.position ).normalize();
		
		if(game._player._playersMesh == undefined)
			return;

		var coefficient = (game._player._playersMesh.position.y - camera.position.y) / vector.y
		game.setMousePosition(camera.position.clone().addSelf( vector.multiplyScalar( coefficient ) ));
	};

	
render = function() {
		
		// update camera controls
		cameraControls.update();

		// check for intersects
		var vector = new THREE.Vector3( mouse.x, mouse.y, 1 );
		projector.unprojectVector( vector, camera );

		var ray = new THREE.Ray( camera.position, vector.subSelf( camera.position ).normalize() );

		var intersects = ray.intersectObjects( scene.children );

		if ( intersects.length > 0 ) {

			if ( INTERSECTED != intersects[ 0 ].object ) {

				if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );

				INTERSECTED = intersects[ 0 ].object;
				INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
				INTERSECTED.material.emissive.setHex( 0xff0000 );

			}

		} else {

			if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );

			INTERSECTED = null;

		}


		//game.animate();
		//applyForce();
		scene.simulate(undefined, 2);
		requestAnimationFrame( render );
		game.getRenderer().render( scene, camera);
		stats.update();
		gamestats.update();
	};
	
	//window.onload = initGame;
	
	</script>
</head>

</html>
